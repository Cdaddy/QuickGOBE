#! /bin/bash

#fail on error
set -e

VALID_USERS=("uni_qgo" "eddturner");

if [ $# -ne 3 ]; then
    echo "${0} expects 4 arguments: 1.) the configuration release directory, 2.) profile, 3.) vm"
    exit 1;
else
   conf_release_dir=$1;
   requestedProfile=$2;
   requestedVM=$3;
fi

if [ ! -d "$conf_release_dir" ]; then
    echo "Release directory does not exist: $conf_release_dir";
    exit 1;
fi

# source required scripts
if ! source "../common/common" || ! source "../common/common.variables" || ! source "index.variables"; then
    echo "Required properties files were not found. Please make sure you're in the right directory";
    exit 1;
fi

cd "$QUICKGO_REPO_DIR"

git fetch
git checkout "$QUICKGO_BRANCH"
git pull

core_dir="${conf_release_dir}/homes/cores/${CORE_NAME}"

mkdir -p "${core_dir}"
cp -a "${QUICKGO_REPO_DIR}/solr-cores/src/main/cores/${CORE_NAME}/." "${core_dir}"

echo "Fetched solr cores"

# make core dir readable and writable to user and group
chmod -R 774 "$core_dir"

# update core link in $SOLR_CONFIG_DIR directory

symlink_name="${SOLR_CONFIG_DIR}/$requestedProfile/$requestedVM/cores/${CORE_NAME}"
echo ">>>core_dir $core_dir"
echo ">>>symlink_name $symlink_name"
if [ ! -d "$(dirname $symlink_name)" ]; then
    mkdir -p "$(dirname $symlink_name)";
fi

ln -snf "$core_dir" "$symlink_name"

prettyEcho "<success>Symlink</success> ${core_dir} has been <success>updated</success> with new core definitions"
echo
ls -l "$symlink_name" | sed -e 's/^/    /g';
echo