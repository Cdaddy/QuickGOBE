#!/bin/bash

#fail on error
set -e

QUICKGO_LIB_PATH="lib/quickgo"

VALID_USERS=("uni_qgo");

if [ -z "$1" ] || [ "$1" == "submit" ]; then
   echo "No server type was input [dev]";
   exit 1;
else
   solr_server=$1;
fi

if [ -z "$2" ] || [ "$2" == "submit" ]; then
   echo "Missing the release directory to copy the libraries into";
   exit 1;
else
   conf_release_dir=$2;
fi

# read common environment variables
properties_not_found="false";

source "../common/common.variables";
if [ $? -eq 1 ]; then
    properties_not_found="true";
fi

if [ "$properties_not_found" = "true" ]; then
    echo "Required properties files were not found. Please make sure you're in the right directory";
    exit 1;
fi

if [ ! -d "$conf_release_dir" ]; then
    echo "Release directory does not exist: $conf_release_dir";
    exit 1;
else
    lib_dir="${conf_release_dir}/${QUICKGO_LIB_PATH}"

    mkdir -p "$lib_dir"
fi

cd "$QUICKGO_REPO_DIR"

git fetch
git checkout "$QUICKGO_BRANCH"
git pull
mvn -U -DskipTests -P indexing package

#copy QuickGO jar
mkdir -p "$lib_dir"
mv ./indexing/target/*.jar "$lib_dir"

#update simlink to the latest version of the indexing jar
ln -snf "$lib_dir" "${SOLR_CONFIG_DIR}/${QUICKGO_LIB_PATH}"