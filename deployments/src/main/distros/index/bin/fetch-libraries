#! /bin/bash

#fail on error
set -e

QUICKGO_LIB_PATH="lib/quickgo"

VALID_USERS=("uni_qgo");

if [ -z "$1" ] || [ "$1" == "submit" ]; then
   echo "Missing the release directory to copy the libraries into";
   exit 1;
else
   conf_release_dir=$1;
fi

# read common environment variables
properties_not_found="false";

source "../common/common.variables";
if [ $? -eq 1 ]; then
    properties_not_found="true";
fi

if [ "$properties_not_found" = "true" ]; then
    echo "Required properties files were not found. Please make sure you're in the right directory";
    exit 1;
fi

if [ ! -d "$conf_release_dir" ]; then
    echo "Release directory does not exist: $conf_release_dir";
    exit 1;
else
    lib_dir="${conf_release_dir}/${QUICKGO_LIB_PATH}"

    mkdir -p "$lib_dir"
fi

cd "$QUICKGO_REPO_DIR"

#fetch the indexing jar

git fetch
git checkout "$QUICKGO_BRANCH"
git pull
mvn -U -DskipTests -P indexing,solr-plugins package

#copy QuickGO jar
mkdir -p "$lib_dir"
mv ./indexing/target/*.jar "$lib_dir"

echo "Copied QuickGO indexing libraries into ${lib_dir}"

#fetch the Solr plugin jars
mv ./solr-plugin/target/*.jar "$lib_dir"

echo "Copied QuickGO Solr plugins into ${lib_dir}"

#update symlink to the latest version of the indexing jar
ln -snf "$lib_dir" "${SOLR_CONFIG_DIR}/${QUICKGO_LIB_PATH}"

echo "Symlink ${lib_dir} has been updated with new library definitions"
ls -l "${SOLR_CONFIG_DIR}/${QUICKGO_LIB_PATH}" | sed -e 's/^/    /g';
