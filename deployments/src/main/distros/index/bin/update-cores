#! /bin/bash

VALID_USERS=("uni_qgo");

if [ -z "$1" ] || [ "$1" == "submit" ]; then
   echo "No server type was input [dev]";
   exit 1;
else
   solr_server=$1;
fi


# read common environment variables
properties_not_found="false";

source "../common/common.variables";
if [ $? -eq 1 ]; then
    properties_not_found="true";
fi

if [ "$properties_not_found" = "true" ]; then
    echo "Required properties files were not found. Please make sure you're in the right directory";
    exit 1;
fi

current_dir=$(pwd)

cd "$QUICKGO_REPO_DIR"

git fetch
git checkout master
git pull

if [ -d "$SOLR_CORES_DIR" ]; then
        archives="$SOLR_CORES_DIR-archives";

        if [ ! -d "$archives" ]; then
                mkdir --parent "$archives";
        fi

        backup="$archives/$(addTimeStamp cores).old";
        echo "Archiving old cores directory '$SOLR_CORES_DIR' to '$backup'"
        mv $SOLR_CORES_DIR $backup

        cd "$archives";

        echo "Deleting oldest archives, but keeping newest 5";
        (ls -t|head -n 5;ls)|sort|uniq -u|xargs rm -rf
else
        mkdir --parent $SOLR_CORES_DIR
fi

cp -r "${QUICKGO_REPO_DIR}/solr-cores/src/main/cores" $SOLR_CORES_DIR