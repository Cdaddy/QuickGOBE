#! /bin/bash

##=========================================================================================
# Starts the self-contained web-application
##=========================================================================================

set -eo pipefail
IFS=$'\n\t '

source "../common/common.variables"

# ======= read the variables used by the control scripts =======================================
source "environment.variables" || {
    echo "Please create a file called, environment.variables, containing the necessary environment variables."
    exit 1;
}

# ======= CONSTANTS =======================================
PERMITTED_USER="uni_qgo"

# ====== check which environment will be started =====================================
if [[ $(check_profile $1) == "0" ]]; then
   profile="$1"
else
   echo "Input profile: ${1}, not recognized. Allowable values: ${ALLOWABLE_PROFILES}"
   exit 1
fi

# ======= check the right user runs this script =======================================
if ! echo "$PERMITTED_USER" | grep "$USER" > /dev/null 2>&1; then
    echo "This service can only be run as user(s), '$PERMITTED_USER'";
    exit 1;
fi;

#grab the virtual machines to startup
vms=$(get_hosts $profile)

if [ -z "$vms" ]; then
   echo "No virtual machines configured for profile: $profile"
   exit 1;
fi

#startup each vm in the list
for vm in $vms; do
  ssh "$PERMITTED_USER"@"$vm" CURRENT_DIR="$(pwd -P)" 'bash -s' < ../start_on_vm
done
